
# vérification des conditions d'applications

## 1) Nombre d'évènements ~ > 10x le nombre de paramètres
nb_evenements <- sum(datas$y_num)
nb_variables <- length(datas_glm) - 1
if (nb_evenements < nb_variables*10){cat("\n Avertissement : ",nb_variables," variables pour ",nb_evenements," évènements ; le modèle peut être incorect")}

## 2) absence de surdispersion
### Evaluation de la surdispersion par le ration de la déviance résiduelle sur le nombre de ddl
#ratio <- summary(mod1)$deviance
#ddl <- length(datas$y) - 3






# Boucle de pas
nb_p <- 0
nexpl <- explicatives
nnexpl <- explicatives

while(nb_p < length(explicatives)){
   nexpl <- nnexpl
   cat("\n\n+-------------------+\n Réalisation d'un nouveau modèle de régression logistique avec les variables suivantes :\n ")
   cat(nexpl)
   nb_p <- 0 #on remet le nb de variables significatives à 0
   datas %>%
      dplyr::select(y,all_of(nexpl)) -> ndatas #on sélectionne l'ensemble du DF avec les variables restantes

   # Nouveau modèle de régression logistique
   mod1<- glm(ndatas,family = binomial)
   HR <- exp(summary(mod1)$coefficients[,1]) #exp de la fonction logit
   pval <- summary(mod1)$coefficients[,4]
   rslt <- matrix(nrow = (length(explicatives)+1),ncol = 3)
   rslt[1,] <- c("","OR","p")
   i <- 0
   round <- 3


   for (col in explicatives){
      i <- i + 1
      p <- ifelse(p == 0,"<0.001",round(pval[i+1],round))
      rslt[i+1,] <- c(col,signif(HR[i+1],round),p)
   }
   pire_pval <- 0
   for (i in 1:(length(nexpl))) { #On enlève la pire variable
      if (pval[i+1] < alpha){
         nb_p = nb_p + 1
         cat("\np < ",alpha," pour :",nexpl[i]," (p = ",pval[i+1],"). La variable est conservée.")
      }else {
         cat("\np > ",alpha," pour :",nexpl[i]," (p = ",pval[i+1],"). La variable n'est pas significative")
         if(pval[i+1] >= pire_pval){
            pire <- i+1
            pire_pval <- pval[i+1]}
      }
   }
   nnexpl <- nnexpl[nnexpl != nexpl[pire]] # on enlève la pire variable
}

return(rslt)
}

### Erreur d'indiçage à cause des facteurs
