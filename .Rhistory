var[var == 1] <- "oui"
var <- as.factor(var)
var <- relevel(var, "oui")
}
}
if (levels(var)[1] == "no" & levels(var)[2] == "yes") {
var <- relevel(var, "yes")
}
}
tb <- table(DF[, y], var)
tbm <- margin.table(tb, 1)
verif_level <- margin.table(table(var, DF[, y]), 2)
verif <- TRUE
for (lev in verif_level) {
if (lev == 0)
verif <- FALSE
}
if (verif) {
condition_chi2 <- 0
condition_chi2_B <- TRUE
for (m in chisq.test(var, DF[, y], simulate.p.value = TRUE)$expected) {
if (m < 5) {
#counting EXPECTED modalities under 5. if one > 3 and only 2 column we can apply yate's correction otherwise we apply Fisher
condition_chi2_B <- FALSE
if (m < 3) {
condition_chi2_B <- FALSE
break
} else{
condition_chi2 <- condition_chi2 + 1
}
}
}
if (condition_chi2 > 1) {
condition_chi2_B <- FALSE
}
if (condition_chi2 == 1 & length(levels(var)) > 2) {
condition_chi2_B <- FALSE
}
if (condition_chi2_B) {
clig <- chisq.test(var, DF[, y])$p.value                    # Chi2 test
clig <- signif(clig, 3)
} else{
clig <- fisher.test(var, DF[, y], simulate.p.value = TRUE)$p.value
clig <- signif(clig, 3)
sign <- " (b)"
}
}
} else{
clig <- NA
}
y='nouvelle_AA'
else{
###  if non numeric  ###########################################
for (it in var) { #if a modality's lenght is > 40, we shrink it to 40 characters to fit in the table
if (!is.na(it)) {
if (stringr::str_length(it) > 40)
var[var == it] <- paste0(substr(it, 1, 40), "...")
}
}
var <- as.factor(var)
if (length(levels(var)) >= mutation) { #if there is more than 'mutation' modalities, the last modalities are grouped in 'others' modality
nvar <- as.vector(var)
for (other_levels_i in mutation:length(levels(var))) {
other_levels <- levels(var)[other_levels_i]
nvar[nvar == other_levels] <- "others"
}
nvar -> var
as.factor(var) -> var
}
if (length(levels(var)) >= 2) {
if (length(levels(var)) == 2) {
if (levels(var)[1] == "non" || levels(var)[1] == "NON" || levels(var)[1] == 0 || levels(var)[1] == "0") {
if (levels(var)[2] == "oui")
var <- relevel(var, "oui")
if (levels(var)[2] == "OUI")
var <- relevel(var, "OUI")
if (levels(var)[2] == "1") {
var <- as.character(var)
var[var == "0"] <- "non"
var[var == "1"] <- "oui"
var <- as.factor(var)
var <- relevel(var, "oui")
}
if (levels(var)[2] == 1) {
var <- as.character(var)
var[var == 0] <- "non"
var[var == 1] <- "oui"
var <- as.factor(var)
var <- relevel(var, "oui")
}
}
if (levels(var)[1] == "no" & levels(var)[2] == "yes") {
var <- relevel(var, "yes")
}
}
tb <- table(DF[, y], var)
tbm <- margin.table(tb, 1)
verif_level <- margin.table(table(var, DF[, y]), 2)
verif <- TRUE
for (lev in verif_level) {
if (lev == 0)
verif <- FALSE
}
if (verif) {
condition_chi2 <- 0
condition_chi2_B <- TRUE
for (m in chisq.test(var, DF[, y], simulate.p.value = TRUE)$expected) {
if (m < 5) {
#counting EXPECTED modalities under 5. if one > 3 and only 2 column we can apply yate's correction otherwise we apply Fisher
condition_chi2_B <- FALSE
if (m < 3) {
condition_chi2_B <- FALSE
break
} else{
condition_chi2 <- condition_chi2 + 1
}
}
}
if (condition_chi2 > 1) {
condition_chi2_B <- FALSE
}
if (condition_chi2 == 1 & length(levels(var)) > 2) {
condition_chi2_B <- FALSE
}
if (condition_chi2_B) {
clig <- chisq.test(var, DF[, y])$p.value                    # Chi2 test
clig <- signif(clig, 3)
} else{
clig <- fisher.test(var, DF[, y], simulate.p.value = TRUE)$p.value
clig <- signif(clig, 3)
sign <- " (b)"
}
}
} else{
clig <- NA
}
## Variable with 2 levels #############################
if (length(levels(var)) == 2) {
ligne <- paste0(ligne1, " (", levels(var)[1], ") - no. (%)")
if (overall) {
overall_count <- addmargins(tb)[levels_y + 1,1]
percent_overall <- signif(100*overall_count / length(var),3)
ligne <- c(ligne, paste0(overall_count,"  (",percent_overall,"%)"))
}
for (j in 1:levels_y) {
no <- tb[j, 1]
pn <- signif(100 * no / tbm[j], 3)
ligne <- c(ligne, paste0(no, " (", pn, "%)"))
}
ligne <- c(ligne, paste0(clig, sign))
tabf <- rbind(tabf, ligne) #ajout de la ligne au tableau
} else {
## Variable with more than 2 levels #############################
# First line with only the test result
if (overall) {
ligne <- c(paste0(colnames_definitive[i], " - no. (%)"), rep(" ", levels_y + 1), paste0(clig, sign))
} else {
ligne <- c(paste0(colnames_definitive[i], " - no. (%)"), rep(" ", levels_y), paste0(clig, sign))
}
tabf <- rbind(tabf, ligne)
# other lines
for (n in 1:length(levels(var))) {
# For each modality
if (exit != "html") {
ligne <- paste0("        ", levels(var)[n])
}else {
ligne <- paste0(" \t \t  ", levels(var)[n])
}
if (overall) {
overall_count <- addmargins(tb)[levels_y,n]
percent_overall <- signif(100*overall_count / length(var),3)
ligne <- c(ligne,paste0(overall_count,"  (",percent_overall,"%)"))
}
for (j in 1:levels_y) {
no <- tb[j, n]
pn <- signif(100 * no / tbm[j], 3)
ligne <- c(ligne, paste0(no, " (", pn, "%)"))
}
ligne <- c(ligne, " ")
tabf <- rbind(tabf, ligne) #ajout de la ligne au tableau
}
}
}
tb
tbm
addmargins(tb)
devtools::load_all(".")
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
DF_NC <- as.data.frame(read_excel("../../CDD/Hassk47/DF.xlsx", na = c("NA")))
DF <- as.data.frame(read_excel("../../CDD/Hassk47/DF.xlsx", na = c("NA","NC")))
colnames(DF)
for (i in 1:length(DF)){
if (!(FALSE %in% (levels(as.factor(DF[ ,i])) == c("0","1")))){
as.factor(DF[ ,i]) -> DF[ ,i]
}
}
#####################
# Caractéristiques  #
#####################
DF_NC$delai_diag <- DF$age_diag - DF$age_premiere_reaction
DF_NC$age_diag <- DF$age_diag
DF_NC$age_premiere_reaction <- DF$age_premiere_reaction
DF_NC$duree_persistance_annees <- DF$duree_persistance_annees
DF$cancer <- DF$cancer_actif
table(DF$cancer,DF$nouvelle_AA)
DF$cancer[DF$cancer_remission == 1] <- 1
explicatives = c("nouvelle_AA","sexe","tabac","categorie_profession","moisissures","consommation_reguliere_alcool","addiction","cardiopathie_chronique","IRespi_obstructive","IRenale_chronique","MAI","cancer","cancer_actif","cancer_remission","HTA","diabete_2","atopie","DA...105","oesophagite_eosino...111","urticaire_angioedeme_visage","asthme","polypose","widal","rhinoconjonctivite_chronique","troubles_dig_chroniques","age_premiere_reaction","age_diag","delai_diag","duree_persistance_annees")
autostats::table1(DF[,explicatives],y="nouvelle_AA",overall = FALSE,tests = TRUE)
#####################
# Caractéristiques  #
#####################
DF_NC$delai_diag <- DF$age_diag - DF$age_premiere_reaction
DF_NC$age_diag <- DF$age_diag
DF_NC$age_premiere_reaction <- DF$age_premiere_reaction
DF_NC$duree_persistance_annees <- DF$duree_persistance_annees
DF$cancer <- DF$cancer_actif
table(DF$cancer,DF$nouvelle_AA)
DF$cancer[DF$cancer_remission == 1] <- 1
explicatives = c("nouvelle_AA","sexe","tabac","categorie_profession","moisissures","consommation_reguliere_alcool","addiction","cardiopathie_chronique","IRespi_obstructive","IRenale_chronique","MAI","cancer","cancer_actif","cancer_remission","HTA","diabete_2","atopie","DA...105","oesophagite_eosino...111","urticaire_angioedeme_visage","asthme","polypose","widal","rhinoconjonctivite_chronique","troubles_dig_chroniques","age_premiere_reaction","age_diag","delai_diag","duree_persistance_annees")
autostats::table1(DF[,explicatives],y="nouvelle_AA",overall = FALSE,tests = TRUE)
DF_NC$delai_diag <- DF$delai_diag
DF_NC$age_diag <- DF$age_diag
DF_NC$age_premiere_reaction <- DF$age_premiere_reaction
DF_NC$duree_persistance_annees <- DF$duree_persistance_annees
DF$cancer <- DF$cancer_actif
DF$cancer[DF$cancer_remission == 1] <- 1
explicatives = c("nouvelle_AA","sexe","tabac","categorie_profession","moisissures","consommation_reguliere_alcool","addiction","cardiopathie_chronique","IRespi_obstructive","IRenale_chronique","MAI","cancer","cancer_actif","cancer_remission","HTA","diabete_2","atopie","DA...105","oesophagite_eosino...111","urticaire_angioedeme_visage","asthme","polypose","widal","rhinoconjonctivite_chronique","troubles_dig_chroniques","age_premiere_reaction","age_diag","delai_diag","duree_persistance_annees")
autostats::table1(DF[,explicatives],y="nouvelle_AA",overall = FALSE,tests = TRUE)
explicatives
DF[,explicatives]
table1(DF[,explicatives],y="nouvelle_AA",overall = FALSE,tests = TRUE)
DF$cancer[DF$cancer_remission == 1] <- 1
explicatives = c("nouvelle_AA","sexe","tabac","categorie_profession","moisissures","consommation_reguliere_alcool","addiction","cardiopathie_chronique","IRespi_obstructive","IRenale_chronique","MAI","cancer","cancer_actif","cancer_remission","HTA","diabete_2","atopie","DA...105","oesophagite_eosino...111","urticaire_angioedeme_visage","asthme","polypose","widal","rhinoconjonctivite_chronique","troubles_dig_chroniques","age_premiere_reaction","age_diag","delai_diag","duree_persistance_annees")
table1(DF[,explicatives],y="nouvelle_AA",overall = FALSE,tests = TRUE)
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
DF_NC <- as.data.frame(read_excel("../../CDD/Hassk47/DF.xlsx", na = c("NA")))
DF <- as.data.frame(read_excel("../../CDD/Hassk47/DF.xlsx", na = c("NA","NC")))
colnames(DF)
for (i in 1:length(DF)){
if (!(FALSE %in% (levels(as.factor(DF[ ,i])) == c("0","1")))){
as.factor(DF[ ,i]) -> DF[ ,i]
}
}
#####################
# Caractéristiques  #
#####################
DF$delai_diag <- DF$age_diag - DF$age_premiere_reaction
DF_NC$delai_diag <- DF$delai_diag
DF_NC$age_diag <- DF$age_diag
DF_NC$age_premiere_reaction <- DF$age_premiere_reaction
DF_NC$duree_persistance_annees <- DF$duree_persistance_annees
DF$cancer <- DF$cancer_actif
DF$cancer[DF$cancer_remission == 1] <- 1
explicatives = c("nouvelle_AA","sexe","tabac","categorie_profession","moisissures","consommation_reguliere_alcool","addiction","cardiopathie_chronique","IRespi_obstructive","IRenale_chronique","MAI","cancer","cancer_actif","cancer_remission","HTA","diabete_2","atopie","DA...105","oesophagite_eosino...111","urticaire_angioedeme_visage","asthme","polypose","widal","rhinoconjonctivite_chronique","troubles_dig_chroniques","age_premiere_reaction","age_diag","delai_diag","duree_persistance_annees")
table1(DF[,explicatives],y="nouvelle_AA",overall = FALSE,tests = TRUE)
explicatives = c("nouvelle_AA","sexe","tabac","categorie_profession","moisissures","consommation_reguliere_alcool","addiction","cardiopathie_chronique","IRespi_obstructive","IRenale_chronique","MAI","cancer_actif","cancer_remission","HTA","diabete_2","atopie","DA...105","oesophagite_eosino...111","urticaire_angioedeme_visage","asthme","polypose","widal","rhinoconjonctivite_chronique","troubles_dig_chroniques","age_premiere_reaction","age_diag","delai_diag","duree_persistance_annees")
table1(DF[,explicatives],y="nouvelle_AA",overall = FALSE,tests = TRUE)
#Allergies
DF$nouvelle_histoire_clinique_depuis_diag[DF$nouvelle_histoire_clinique_depuis_diag != 0] <- 1
explicatives = c('nouvelle_AA','famille_allergie_principale','hymenoptere','atcd_AA_guerie','nouvelle_histoire_clinique_depuis_diag','AA_stable','AA_moins_grave','AA_aggravee')
table1(DF_NC[,c(explicatives)], y='nouvelle_AA')
var <- DF$atcd_AA_guerie
var
for (it in var) { #if a modality's lenght is > 40, we shrink it to 40 characters to fit in the table
if (!is.na(it)) {
if (stringr::str_length(it) > 40)
var[var == it] <- paste0(substr(it, 1, 40), "...")
}
}
var <- as.factor(var)
if (length(levels(var)) >= mutation) { #if there is more than 'mutation' modalities, the last modalities are grouped in 'others' modality
nvar <- as.vector(var)
for (other_levels_i in mutation:length(levels(var))) {
other_levels <- levels(var)[other_levels_i]
nvar[nvar == other_levels] <- "others"
}
nvar -> var
as.factor(var) -> var
}
if (length(levels(var)) >= 2) {
if (length(levels(var)) == 2) {
if (levels(var)[1] == "non" || levels(var)[1] == "NON" || levels(var)[1] == 0 || levels(var)[1] == "0") {
if (levels(var)[2] == "oui")
var <- relevel(var, "oui")
if (levels(var)[2] == "OUI")
var <- relevel(var, "OUI")
if (levels(var)[2] == "1") {
var <- as.character(var)
var[var == "0"] <- "non"
var[var == "1"] <- "oui"
var <- as.factor(var)
var <- relevel(var, "oui")
}
if (levels(var)[2] == 1) {
var <- as.character(var)
var[var == 0] <- "non"
var[var == 1] <- "oui"
var <- as.factor(var)
var <- relevel(var, "oui")
}
}
if (levels(var)[1] == "no" & levels(var)[2] == "yes") {
var <- relevel(var, "yes")
}
}
tb <- table(DF[, y], var,useNA = "no")
tbm <- margin.table(tb, 1)
verif_level <- margin.table(table(var, DF[, y]), 2)
verif <- TRUE
for (lev in verif_level) {
if (lev == 0)
verif <- FALSE
}
if (verif) {
condition_chi2 <- 0
condition_chi2_B <- TRUE
for (m in chisq.test(var, DF[, y], simulate.p.value = TRUE)$expected) {
if (m < 5) {
#counting EXPECTED modalities under 5. if one > 3 and only 2 column we can apply yate's correction otherwise we apply Fisher
condition_chi2_B <- FALSE
if (m < 3) {
condition_chi2_B <- FALSE
break
} else{
condition_chi2 <- condition_chi2 + 1
}
}
}
if (condition_chi2 > 1) {
condition_chi2_B <- FALSE
}
if (condition_chi2 == 1 & length(levels(var)) > 2) {
condition_chi2_B <- FALSE
}
if (condition_chi2_B) {
clig <- chisq.test(var, DF[, y])$p.value                    # Chi2 test
clig <- signif(clig, 3)
} else{
clig <- fisher.test(var, DF[, y], simulate.p.value = TRUE)$p.value
clig <- signif(clig, 3)
sign <- " (b)"
}
}
} else{
clig <- NA
}
## Variable with 2 levels #############################
if (length(levels(var)) == 2) {
ligne <- paste0(ligne1, " (", levels(var)[1], ") - no. (%)")
if (overall) {
overall_count <- addmargins(tb)[levels_y + 1,1]
percent_overall <- signif(100*overall_count / length(var),3)
ligne <- c(ligne, paste0(overall_count,"  (",percent_overall,"%)"))
}
for (j in 1:levels_y) {
no <- tb[j, 1]
pn <- signif(100 * no / tbm[j], 3)
ligne <- c(ligne, paste0(no, " (", pn, "%)"))
}
ligne <- c(ligne, paste0(clig, sign))
tabf <- rbind(tabf, ligne) #ajout de la ligne au tableau
} else {
## Variable with more than 2 levels #############################
# First line with only the test result
if (overall) {
ligne <- c(paste0(colnames_definitive[i], " - no. (%)"), rep(" ", levels_y + 1), paste0(clig, sign))
} else {
ligne <- c(paste0(colnames_definitive[i], " - no. (%)"), rep(" ", levels_y), paste0(clig, sign))
}
tabf <- rbind(tabf, ligne)
# other lines
for (n in 1:length(levels(var))) {
# For each modality
if (exit != "html") {
ligne <- paste0("        ", levels(var)[n])
}else {
ligne <- paste0(" \t \t  ", levels(var)[n])
}
if (overall) {
overall_count <- addmargins(tb)[levels_y,n]
percent_overall <- signif(100*overall_count / length(var),3)
ligne <- c(ligne,paste0(overall_count,"  (",percent_overall,"%)"))
}
for (j in 1:levels_y) {
no <- tb[j, n]
pn <- signif(100 * no / tbm[j], 3)
ligne <- c(ligne, paste0(no, " (", pn, "%)"))
}
ligne <- c(ligne, " ")
tabf <- rbind(tabf, ligne) #ajout de la ligne au tableau
}
}
ligne
overall_count
tb
levels_y
level_y=2
overall_count <- addmargins(tb)[levels_y + 1,1]
levels_y=2
overall_count <- addmargins(tb)[levels_y + 1,1]
percent_overall <- signif(100*overall_count / length(var),3)
overall_count
tb
table1(DF_NC[,c(explicatives)], y='nouvelle_AA')
y='nouvelle_AA'
for (it in var) { #if a modality's lenght is > 40, we shrink it to 40 characters to fit in the table
if (!is.na(it)) {
if (stringr::str_length(it) > 40)
var[var == it] <- paste0(substr(it, 1, 40), "...")
}
}
var <- as.factor(var)
if (length(levels(var)) >= mutation) { #if there is more than 'mutation' modalities, the last modalities are grouped in 'others' modality
nvar <- as.vector(var)
for (other_levels_i in mutation:length(levels(var))) {
other_levels <- levels(var)[other_levels_i]
nvar[nvar == other_levels] <- "others"
}
nvar -> var
as.factor(var) -> var
}
if (length(levels(var)) >= 2) {
if (length(levels(var)) == 2) {
if (levels(var)[1] == "non" || levels(var)[1] == "NON" || levels(var)[1] == 0 || levels(var)[1] == "0") {
if (levels(var)[2] == "oui")
var <- relevel(var, "oui")
if (levels(var)[2] == "OUI")
var <- relevel(var, "OUI")
if (levels(var)[2] == "1") {
var <- as.character(var)
var[var == "0"] <- "non"
var[var == "1"] <- "oui"
var <- as.factor(var)
var <- relevel(var, "oui")
}
if (levels(var)[2] == 1) {
var <- as.character(var)
var[var == 0] <- "non"
var[var == 1] <- "oui"
var <- as.factor(var)
var <- relevel(var, "oui")
}
}
if (levels(var)[1] == "no" & levels(var)[2] == "yes") {
var <- relevel(var, "yes")
}
}
tb <- table(DF[, y], var,useNA = "no")
tbm <- margin.table(tb, 1)
verif_level <- margin.table(table(var, DF[, y]), 2)
verif <- TRUE
for (lev in verif_level) {
if (lev == 0)
verif <- FALSE
}
if (verif) {
condition_chi2 <- 0
condition_chi2_B <- TRUE
for (m in chisq.test(var, DF[, y], simulate.p.value = TRUE)$expected) {
if (m < 5) {
#counting EXPECTED modalities under 5. if one > 3 and only 2 column we can apply yate's correction otherwise we apply Fisher
condition_chi2_B <- FALSE
if (m < 3) {
condition_chi2_B <- FALSE
break
} else{
condition_chi2 <- condition_chi2 + 1
}
}
}
if (condition_chi2 > 1) {
condition_chi2_B <- FALSE
}
if (condition_chi2 == 1 & length(levels(var)) > 2) {
condition_chi2_B <- FALSE
}
if (condition_chi2_B) {
clig <- chisq.test(var, DF[, y])$p.value                    # Chi2 test
clig <- signif(clig, 3)
} else{
clig <- fisher.test(var, DF[, y], simulate.p.value = TRUE)$p.value
clig <- signif(clig, 3)
sign <- " (b)"
}
}
} else{
clig <- NA
}
overall_count <- addmargins(tb)[levels_y + 1,1]
percent_overall <- signif(100*overall_count / length(var),3)
overall_count
tb
var
table1(DF_NC[,c(explicatives)], y='nouvelle_AA')
tb
addmargins(tb)
addmargins(tb)[levels_y + 1,1]
paste0(overall_count,"  (",percent_overall,"%)")
devtools::load_all(".")
table1(DF_NC[,c(explicatives)], y='nouvelle_AA')
table1(DF_NC[,c(explicatives)], y='nouvelle_AA')
#Allergie croisée
table1::table1(~alphagal...114+gluten+tropomyosine|famille_allergie_principale,data=DF_NC)
table1(DF_NC[,c(explicatives)], y='nouvelle_AA')
tb
addmargins(tb)
devtools::load_all(".")
table1(DF_NC[,c(explicatives)], y='nouvelle_AA')
DF_NC$hymenoptere <- as.factor(DF_NC$hymenoptere)
table1(DF_NC[,c(explicatives)], y='nouvelle_AA')
